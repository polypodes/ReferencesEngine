var utilsClass=function(){this.fixVScrollHeight=function(){var e=$("aside .scrollable").offset(),t=$(document).height();$("aside .scrollable").css("height",t-e.top+"px")},this.fixBottomBoxHeight=function(){var e=$(".new_project_wysiwyg").height(),t=$(document).height(),o=t-(e+100);console.log(o),$(".bottom_box").css("height",o+"px")}},canvasClass=function(){function e(e){var t=e.cover.width,o=e.cover.height;d=t/o;var r=t/o,a=o/t;t>c&&(t=c,o=t*a),o>l&&(o=l,t=o*r);var n=new Kinetic.Image({x:0,y:0,image:e.cover,width:t,height:o,name:"image"});i.add(n),addAnchor(i,0,0,"topLeft"),addAnchor(i,t,0,"topRight"),addAnchor(i,t,o,"bottomRight"),addAnchor(i,0,o,"bottomLeft")}this.ctx=null,loadImages=function(e,t){var o={},i=0,r=0;for(var a in e)r++;for(var a in e)o[a]=new Image,o[a].onload=function(){++i>=r&&t(o)},o[a].src=e[a]},update=function(e){var t=e.getParent(),o=t.find(".topLeft")[0],i=t.find(".topRight")[0],r=t.find(".bottomRight")[0],a=t.find(".bottomLeft")[0],n=t.find(".image")[0],s=e.x(),c=e.y();switch(e.name()){case"topLeft":i.y(c),a.x(s);break;case"topRight":o.y(c),r.x(s);break;case"bottomRight":a.y(c),i.x(s);break;case"bottomLeft":r.y(c),o.x(s)}n.setPosition(o.getPosition());var l=i.x()-o.x(),d=a.y()-o.y();l&&d&&n.setSize({width:l,height:d})},addAnchor=function(e,t,o,i){var r=(e.getStage(),e.getLayer()),a=new Kinetic.Circle({x:t,y:o,stroke:"#666",fill:"#ddd",strokeWidth:2,radius:8,name:i,draggable:!0,dragOnTop:!1});a.on("dragmove",function(){update(this),r.draw()}),a.on("mousedown touchstart",function(){e.setDraggable(!1)}),a.on("dragend",function(){e.setDraggable(!0),r.draw()}),a.on("mouseover",function(){var e=this.getLayer();document.body.style.cursor="pointer",this.setStrokeWidth(4),e.draw()}),a.on("mouseout",function(){var e=this.getLayer();document.body.style.cursor="default",this.strokeWidth(2),e.draw()}),e.add(a)};var t=null,o=null,i=null,r=null,a=null,n=null,s=1.41428571,c=500,l=500*s,d=null;this.initStage=function(s){o=new Kinetic.Stage({container:"canvas",width:c,height:l});var d=new Kinetic.Rect({x:0,y:0,width:500,height:710,fill:"#FFFFFF"});i=new Kinetic.Group({x:0,y:0,draggable:!0}),r=new Kinetic.Group({x:10,y:40,draggable:!0}),a=new Kinetic.Group({x:10,y:110,draggable:!0}),n=new Kinetic.Group({x:10,y:650,draggable:!0}),t=new Kinetic.Layer,t.add(d),t.add(i),t.add(r),t.add(a),t.add(n),o.add(t),e(s),o.draw()};var p={x:20,y:20};this.addText=function(e,o,i){r.removeChildren(),a.removeChildren(),n.removeChildren();var s=new Kinetic.Text({x:p.x,y:p.y,text:e.text,fontSize:e.fontsize,fontFamily:e.fontfamily,fill:e.color,fontStyle:"300"}),c=new Kinetic.Text({x:p.x,y:p.y,text:o.text,fontSize:o.fontsize,fontFamily:o.fontfamily,fill:o.color,fontStyle:"300",lineHeight:1.5}),l=new Kinetic.Text({x:p.x,y:p.y,text:i.text,fontSize:i.fontsize,fontFamily:i.fontfamily,fill:i.color,fontStyle:"300"});r.add(s),a.add(c),n.add(l),t.draw()},this.addImage=function(o){console.log("addimage"),i.removeChildren(),loadImages({cover:o},function(o){e(o),t.draw()})},this.exportCover=function(){o.toDataURL({callback:function(e){window.open(e)}})},this.sources={cover:"src/images/sample.jpg"};loadImages(this.sources,this.initStage)},utils=new utilsClass,App=angular.module("App",["ngRoute","ui.sortable","LocalStorageModule","ngUpload","ngAnimate"]).config(["localStorageServiceProvider",function(e){e.setPrefix("_rfktor")}]);App.run(["$rootScope",function(e){e.notify={state:"closed",title:"title",message:"message"}}]),App.factory("Projects",["localStorageService",function(e){return{get:function(t){var o=e.get("projects");if(0!=t){var i=[];for(var r in o)o[r].category==t&&i.push(o[r])}else i=o;return i},get_by_id:function(t){var o=e.get("projects");for(var i in o)if(o[i].id==t)return o[i]},saveLocal:function(t){e.set("projects",t),console.log("saved projects to localstorage")}}}]),App.factory("Books",["localStorageService",function(e){var t=e.get("books");return{get:function(e){if(0!=e){var o=[];for(var i in t)t[i].category==e&&o.push(t[i])}else o=t;return o},get_by_id:function(){return{test:"test"}},saveLocal:function(t){e.set("books",t),console.log("saved books to localstorage")}}}]),App.factory("Categories",["localStorageService",function(e){var t=e.get("categories");return{get:function(){for(var e in t)for(var o in t[e])null!=t[e][o].id&&(t[e][o].path="/"+e+"/"+t[e][o].id);return null==t&&(t={projects:[{id:0,title:"Tous les projets",path:"/projects/"}],books:[{id:0,title:"Tous les cahiers",path:"/books/"}]}),t},saveLocal:function(t){e.set("categories",t)}}}]),App.factory("Themes",function(){return{get:function(){var e=[{id:0,title:"Theme 1",src:"theme1"},{id:1,title:"Theme 2",src:"theme2"},{id:2,title:"Theme 3",src:"theme3"},{id:3,title:"Theme 4",src:"theme4"}];return e}}}),App.factory("navService",function(){var e="overview";return{getProperty:function(){return e},setProperty:function(t){e=t}}}),App.directive("focusOn",function(){return function(e,t,o){e.$on(o.focusOn,function(){setTimeout(function(){t[0].focus()},1)})}}),App.directive("file",function(){return{require:"ngModel",restrict:"A",link:function(e,t){t.bind("change",function(){$("input.fileSubmit").trigger("click"),e.$apply()})}}}),App.directive("cover",function(){return{require:"ngModel",restrict:"A",link:function(e,t){t.bind("change",function(){$("input.fileSubmitCover").trigger("click"),e.$apply()})}}}),App.factory("Notify",["$rootScope","$timeout",function(e,t){return e.notify="opened",function(o,i,r){function a(){console.log("reinit"),t.cancel(n),n=t(function(){e.notify.state="closed"},2500)}e.notify={state:"opened",type:o,title:i,msg:r};var n;a(),$(".info-box").hover(function(){t.cancel(n)},function(){a()})}}]),App.config(["$routeProvider",function(e){e.when("/projects/:project_id?",{templateUrl:"src/views/projects.html",controller:"ProjectsCtrl"}).when("/project/:project_id?",{templateUrl:"src/views/project_add.html",controller:"AddProjectCtrl"}).when("/books",{templateUrl:"src/views/books.html",controller:"BooksCtrl"}).when("/books/:book_id?",{templateUrl:"src/views/books.html",controller:"BooksCtrl"}).when("/add_project",{templateUrl:"src/views/project_add.html",controller:"AddProjectCtrl"}).when("/add_book",{templateUrl:"src/views/book_add.html",controller:"AddBookCtrl"}).when("/overview",{templateUrl:"src/views/overview.html",controller:"OverviewCtrl"}).otherwise({redirectTo:"/overview"})}]),App.controller("NavCtrl",["$scope","$location","Categories",function(e,t,o){e.pageTitle="",e.mainItems=[{path:"/overview",title:"Vue d'ensemble",icon:"fa-tachometer"},{path:"/settings",title:"Réglages",icon:"fa-cog"}],e.addItems=[{path:"/add_project",title:"Ajouter un projet"},{path:"/add_book",title:"Ajouter un cahier"}],e.categoriesItems=o.get(),o.saveLocal(e.categoriesItems),e.isActive=function(o){return o.path==t.path()?(e.pageTitle=o.title,!0):!1},e.inputCategory={project:"",book:""},e.addProjectCategory=function(t){if(13===t.which||"click"==t.type&&""!=e.inputCategory.project){var i=0;for(var r in e.categoriesItems.projects)"function"!=typeof e.categoriesItems.projects[r]&&(i=e.categoriesItems.projects[r].id);e.categoriesItems.projects.push({id:parseInt(i)+1,title:e.inputCategory.project,path:"/projects/"+(parseInt(i)+1)}),e.inputCategory.project="",o.saveLocal(e.categoriesItems)}},e.addBookCategory=function(t){if(13===t.which||"click"==t.type&&""!=e.inputCategory.book){var i=0;for(var r in e.categoriesItems.books)"function"!=typeof e.categoriesItems.books[r]&&(i=e.categoriesItems.books[r].id);e.categoriesItems.books.push({id:parseInt(i)+1,title:e.inputCategory.book,path:"/books/"+(parseInt(i)+1)}),e.inputCategory.book="",o.saveLocal(e.categoriesItems)}},e.deleteCategory=function(t,i){"projects"==t?e.categoriesItems.projects.splice(i,1):"books"==t&&e.categoriesItems.books.splice(i,1),o.saveLocal(e.categoriesItems)}}]),App.controller("AddBookCtrl",["$scope","Projects","Themes","$http",function(e,t,o,i){e.pageTitle="Ajouter un cahier",utils.fixVScrollHeight();var r=t.get(0);for(var a in r)r[a].added=!1;e.projects=r,e.projects_a=[],e.presentation_type={my_projects:"block",all_projects:"block"},e.themes=o.get(),e.theme_a={},e.changePresentation=function(t,o){"my_projects"==o?e.presentation_type.my_projects=t:"all_projects"==o&&(e.presentation_type.all_projects=t)},e.addToList=function(t){var o=0;for(var i in e.projects)t==e.projects[i].id&&(o=i);if(e.projects[o].added){e.projects[o].added=!1;for(var i in e.projects_a)e.projects_a[i].id==e.projects[o].id&&e.projects_a.splice(i,1)}else e.projects[o].added=!0,e.projects_a.push(e.projects[o])},e.openedSlide="couv",e.openDetails=function(t){e.openedSlide=t},e.sortableOptions={axis:"y"},e.book={cover:"",btitle:"Titre du cahier",subtitle:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Optio, eum mollitia voluptatibus. Tempore impedit reprehenderit blanditiis praesentium ab, nemo nisi, quas eaque, voluptatem perferendis quidem, architecto exercitationem saepe facilis illo.",bottomline:"Pour [NOM DU CLIENT] fait le [DATE]"},e.couv_state={},e.chooseTheme=function(t){e.book.theme=e.themes[t]},e.isUploading=!1,e.uploadImg=function(){e.isUploading=!0},e.uploadCoverComplete=function(t){e.isUploading=!1,"success"==t.status&&(e.book.cover="uploads/files/"+t.fileName,console.log(e.book.cover))},e.bookInfoKeypress=function(){void 0!=e.book.btitle&&void 0!=e.book.image&&""!=e.book.btitle&&""!=e.book.image&&("coverEditor"!=e.couv_state.a4&&(e.couv_state.a4="generated"),e.couv_state.pres="generated",e.couv_state.web="generated")},e.previewBook=function(){var t={book:{couv:e.book,couv_state:e.couv_state,theme:e.theme_a},slides:e.projects_a};i({method:"POST",url:"templating/generate_json.php",data:$.param({data:t}),headers:{"Content-Type":"application/x-www-form-urlencoded"}})},e.openEditor=function(){e.book.projects=e.projects_a,console.log(e.book),console.log("saving")}}]),App.controller("BooksCtrl",["$scope","Books","navService","$routeParams",function(e,t,o,i){e.books=t.get(i.book_id),t.saveLocal(e.books)}]),App.controller("ProjectsCtrl",["$scope","Projects","$routeParams","Notify",function(e,t,o,i){e.projects=t.get(o.project_id),e.deleteProject=function(o){for(var r in e.projects)e.projects[r].id==o&&(e.projects.splice(r,1),i("success","Projet supprimé","Le projet a été supprimé avec succès"));t.saveLocal(e.projects)}}]),App.controller("AddProjectCtrl",["$scope","Projects","Categories","$routeParams","Notify",function(e,t,o,i,r){utils.fixBottomBoxHeight(),e.categories=o.get(),e.projects=t.get(0);var a=new Date;e.project_data={intro:"Introduction au projet",title:"Titre du projet",date:a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),desc:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Adipisci repellendus alias modi praesentium, delectus! Itaque odit ratione sit quisquam quia, cum quaerat ipsam mollitia vero deserunt. Asperiores atque nesciunt quidem.",tags:[],category:0,cover:"#",files:[]},e.isUploading=!1,e.uploadImg=function(){e.isUploading=!0},void 0!=i.project_id&&(e.project_data=t.get_by_id(i.project_id)),e.addProject=function(){var o=e.project_data,r=0;if(null==o.id){for(var a in e.projects)r=e.projects[a].id;o.id=r+1,e.projects.push(o)}else if(void 0!=i.project_id){for(var a in e.projects)e.projects[a].id==o.id&&(r=a);e.projects[a]=o}t.saveLocal(e.projects)},e.selectCategory=function(t){e.project_data.category=e.categories.projects[t].id},e.addTag=function(t){13===t.which&&""!=e.addedTag&&(e.project_data.tags.push(e.addedTag),e.addedTag="")},e.deleteTag=function(t){return e.project_data.tags.splice(t,1),!1},e.uploadCoverComplete=function(t){console.log(t),e.isUploading=!1,"success"==t.status?e.project_data.cover="uploads/files/"+t.fileName:r("error","Erreur d'upload","Image de couverture refusée, verifiez la taille et l'extension de votre fichier.")},e.uploadComplete=function(t){e.isUploading=!1,"success"==t.status?e.project_data.files.push({path:"uploads/files/"+t.fileName}):r("error","Erreur d'upload","Upload refusé, verifiez la taille et l'extension de votre fichier.")}}]),App.controller("OverviewCtrl",["$scope","Projects",function(e){e.pageTitle="Vue d'ensemble",$("canvas#consultations").attr("width",$(".top .graph").width()-40);{var t=document.getElementById("consultations").getContext("2d"),o={labels:["08/07","09/07","10/07","11/07","12/07","13/07","14/07","15/07"],datasets:[{label:"Consultations",fillColor:"rgba(101,208,186,0.15)",strokeColor:"rgba(101,208,186,1)",pointColor:"rgba(46,179,152,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:[30,65,59,80,81,56,55,40]}]},i={scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:!0,bezierCurveTension:.4,pointDot:!0,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:20,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].lineColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'};new Chart(t).Line(o,i)}}]);