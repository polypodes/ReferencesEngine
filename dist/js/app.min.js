var utils=new utilsClass,App=angular.module("App",["gridster","ngRoute","ui.sortable","LocalStorageModule","ngUpload","ngAnimate"]).config(["localStorageServiceProvider",function(e){e.setPrefix("_rfktor")}]);App.run(["$rootScope",function(e){e.notify={state:"closed",title:"title",message:"message"}}]),App.directive("focusOn",function(){return function(e,t,o){e.$on(o.focusOn,function(){setTimeout(function(){t[0].focus()},1)})}}),App.directive("itemAnimation",function(){return function(e){e.$last&&$(".items .item").each(function(e,t){setTimeout(function(){$(t).addClass("visible")},50*e)})}}),App.directive("file",function(){return{require:"ngModel",restrict:"A",link:function(e,t){t.bind("change",function(){$("input.fileSubmit").trigger("click"),e.$apply()})}}}),App.directive("cover",function(){return{require:"ngModel",restrict:"A",link:function(e,t){t.bind("change",function(){$("input.fileSubmitCover").trigger("click"),e.$apply()})}}}),App.directive("backImg",function(){return function(e,t,o){var r=o.backImg;t.css({"background-image":"url("+r+")","background-size":"cover"})}}),App.factory("Notify",["$rootScope","$timeout",function(e,t){function o(){t.cancel(r),r=t(function(){e.notify.state="closed"},2500)}e.notify.state="closed";var r;return e.notify="opened",function(i,a,s){"close"==i?"question"==e.notify.type&&(e.notify.state="closed"):(e.dialogClick=function(t){e.$broadcast("clickDialog",{choice:t})},e.notify={state:"opened",type:i,title:a,msg:s},"question"!=i&&(o(),$(".info-box").hover(function(){t.cancel(r)},function(){o()})))}}]),App.config(["$routeProvider",function(e){e.when("/projects/:project_id?",{templateUrl:"src/views/projects.html",controller:"ProjectsCtrl"}).when("/project/:project_id?",{templateUrl:"src/views/project_add.html",controller:"AddProjectCtrl"}).when("/books/:book_id?",{templateUrl:"src/views/books.html",controller:"BooksCtrl"}).when("/book/:book_id?/edit",{templateUrl:"src/views/editor.html",controller:"BookEditorCtrl"}).when("/book/:book_id?",{templateUrl:"src/views/book_add.html",controller:"AddBookCtrl"}).when("/add_project",{templateUrl:"src/views/project_add.html",controller:"AddProjectCtrl"}).when("/add_book",{templateUrl:"src/views/book_add.html",controller:"AddBookCtrl"}).when("/overview",{templateUrl:"src/views/overview.html",controller:"OverviewCtrl"}).when("/settings",{templateUrl:"src/views/settings.html",controller:"SettingsCtrl"}).otherwise({redirectTo:"/overview"})}]),App.controller("NavCtrl",["$scope","$location","Categories","Notify",function(e,t,o,r){e.pageTitle="",e.mainItems=[{path:"/overview",title:"Vue d'ensemble",icon:"fa-tachometer"},{path:"/settings",title:"Réglages",icon:"fa-cog"}],e.addItems=[{path:"/add_project",title:"Ajouter un projet"},{path:"/add_book",title:"Ajouter un cahier"}],e.categoriesItems=o.get(),o.saveLocal(e.categoriesItems),e.isActive=function(o){return o.path==t.path()?(e.pageTitle=o.title,!0):!1},e.inputCategory={project:"",book:""},e.addProjectCategory=function(t){if(13===t.which||"click"==t.type&&""!==e.inputCategory.project){var r=0;for(var i in e.categoriesItems.projects)"function"!=typeof e.categoriesItems.projects[i]&&(r=e.categoriesItems.projects[i].id);e.categoriesItems.projects.push({id:parseInt(r)+1,title:e.inputCategory.project,path:"/projects/"+(parseInt(r)+1)}),e.inputCategory.project="",o.saveLocal(e.categoriesItems)}},e.addBookCategory=function(t){if(13===t.which||"click"==t.type&&""!==e.inputCategory.book){var r=0;for(var i in e.categoriesItems.books)"function"!=typeof e.categoriesItems.books[i]&&(r=e.categoriesItems.books[i].id);e.categoriesItems.books.push({id:parseInt(r)+1,title:e.inputCategory.book,path:"/books/"+(parseInt(r)+1)}),e.inputCategory.book="",o.saveLocal(e.categoriesItems)}},e.deleteCategory=function(t,r){"projects"==t?e.categoriesItems.projects.splice(r,1):"books"==t&&e.categoriesItems.books.splice(r,1),o.saveLocal(e.categoriesItems)};var i=0;e.goBack=function(){window.history.back(),i-=2},e.$on("$routeChangeSuccess",function(){r("close"),e.isPrev=i>=1?!0:!1,i++})}]),App.factory("navService",function(){var e="overview";return{getProperty:function(){return e},setProperty:function(t){e=t}}}),App.factory("Categories",["localStorageService",function(e){var t=e.get("categories");return{get:function(){for(var e in t)for(var o in t[e])null!==t[e][o].id&&(t[e][o].path="/"+e+"/"+t[e][o].id);return null===t&&(t={projects:[{id:0,title:"Tous les projets",path:"/projects/"}],books:[{id:0,title:"Tous les cahiers",path:"/books/"}]}),t},saveLocal:function(t){e.set("categories",t)}}}]),App.controller("OverviewCtrl",["$scope","Projects","Stats",function(e,t,o){e.pageTitle="Vue d'ensemble",e.stats=o.getForDashboard(),$("canvas#consultations").attr("width",$(".top .graph").width()-40);{var r=document.getElementById("consultations").getContext("2d"),i={labels:e.stats.views.timeline.labels,datasets:[{label:"Consultations",fillColor:"rgba(101,208,186,0.15)",strokeColor:"rgba(101,208,186,1)",pointColor:"rgba(46,179,152,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:e.stats.views.timeline.data}]},a={scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:!0,bezierCurveTension:.4,pointDot:!0,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:10,showTooltips:!0,responsive:!0,datasetStroke:!1,datasetStrokeWidth:2,datasetFill:!0};new Chart(r).Line(i,a)}}]),App.factory("Stats",function(){return{getForDashboard:function(){var e=new Date,t=new Date;t.setDate(t.getDate()-14);for(var o,r=[],i=[];e>=t;){o=e.getDate(),e=new Date(e.setDate(--o));var a=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();r.push(a);var s=Math.floor(301*Math.random());i.push(s)}var n={views:{web:{today:Math.floor(100*Math.random()),yesterday:Math.floor(100*Math.random()),total:Math.floor(2e3*Math.random())+2e3},pdf:{today:Math.floor(100*Math.random()),yesterday:Math.floor(100*Math.random()),total:Math.floor(2e3*Math.random())+2e3},pres:{today:Math.floor(100*Math.random()),yesterday:Math.floor(100*Math.random()),total:Math.floor(2e3*Math.random())+2e3},timeline:{labels:r,data:i}}};return n.views.total={today:n.views.web.today+n.views.pdf.today+n.views.pres.today,yesterday:n.views.web.yesterday+n.views.pdf.yesterday+n.views.pres.yesterday,total:n.views.web.total+n.views.pdf.total+n.views.pres.total},n.views.variations={growth:Math.ceil((n.views.total.today-n.views.total.yesterday)/n.views.total.yesterday*100),new_visits:n.views.total.today-n.views.total.yesterday},n.views.variations.growth>=0&&(n.views.variations.growth="+"+n.views.variations.growth),n.views.variations.new_visits>=0&&(n.views.variations.new_visits="+"+n.views.variations.new_visits),n}}}),App.controller("SettingsCtrl",["$scope",function(){}]),App.controller("AddBookCtrl",["$scope","Projects","Themes","$http","Books","$routeParams","Notify","$location","Categories",function(e,t,o,r,i,a,s,n,c){e.pageTitle="Ajouter un cahier",utils.fixVScrollHeight();var l=t.get(0);e.categories=c.get(),e.projects=l,e.projects_a=[],e.presentation_type={my_projects:"block",all_projects:"block"},e.themes=o.get(),e.changePresentation=function(t,o){"my_projects"==o?e.presentation_type.my_projects=t:"all_projects"==o&&(e.presentation_type.all_projects=t)},e.addToList=function(t){var o=0;for(var r in e.projects)t==e.projects[r].id&&(o=r);if(e.projects[o].added){e.projects[o].added=!1;for(var i in e.projects_a)e.projects_a[i].id==e.projects[o].id&&e.projects_a.splice(i,1)}else e.projects[o].added=!0,e.projects_a.push(e.projects[o])},e.selectCategory=function(t){e.book.category=e.categories.books[t].id},e.sortableOptions={axis:"y"},void 0!==a.book_id?(e.book=i.getById(a.book_id),e.projects_a=e.book.projects_a):e.book={btitle:"Titre du cahier",subtitle:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Optio, eum mollitia voluptatibus. Tempore impedit reprehenderit blanditiis praesentium ab, nemo nisi, quas eaque, voluptatem perferendis quidem, architecto exercitationem saepe facilis illo.",bottomline:"Pour [NOM DU CLIENT] fait le [DATE]",cover:"dist/img/sample.png",date:"date",category:0,theme:e.themes[0],exported:!1};for(var p in l)l[p].added=!1;for(var u in e.projects_a)for(var d in e.projects)e.projects_a[u].id==e.projects[d].id&&(e.projects[d].added=!0);e.chooseTheme=function(t){e.book.theme=e.themes[t]},e.chooseTheme(0),e.isUploading=!1,e.uploadImg=function(){e.isUploading=!0},e.uploadCoverComplete=function(t){e.isUploading=!1,"success"==t.status&&(e.book.cover="uploads/files/"+t.fileName)},e.saveBook=function(){var t=e.book;t.projects_a=e.projects_a;var o=i.validate(t);if(o!==!0)return s("error","Erreur lors de l'ajout",o),!1;var r;t.hasOwnProperty("id")?void 0!==a.book_id&&(r=t.id,i.edit(r,t),s("success","Cahier modifié","Le cahier a été modifié avec succès. Vous pouvez effectuer les derniers réglages via la prévisualisation.")):(r=i.add(t),s("success","Cahier ajouté","Le cahier a été ajouté à votre liste. Vous pouvez effectuer les derniers réglages via la prévisualisation.")),n.path("/book/"+r+"/edit")}}]),App.controller("BookEditorCtrl",["$scope","Books","navService","$routeParams","Notify","$location","$http",function(e,t,o,r,i,a,s){e.book=t.getById(r.book_id),$("link.template").attr("href","src/templates/"+e.book.theme.src+".css"),e.gridsterOpts={columns:4,rows:4,pushing:!0,floating:!0,width:"auto",colWidth:"auto",rowHeight:"match",margins:[10,10],outerMargin:!0,minColumns:1,minRows:1,maxRows:4,defaultSizeX:1,defaultSizeY:1,mobileBreakPoint:1,resizable:{enabled:!0,handles:"se",start:function(){},resize:function(){},stop:function(){}},draggable:{enabled:!0,start:function(){},drag:function(){},stop:function(){}}},e.saveBook=function(o){var a=e.book,s=t.validate(a);if(s!==!0)return i("error","Erreur lors de l'ajout",s),!1;if(void 0!==r.book_id){var n=a.id;t.edit(n,a),o===!0&&i("success","Cahier ajouté","Le cahier a été modifié avec succès")}},e.pages=[{text:"cover"},{text:"page 1"},{text:"page 2"},{text:"page 3"},{text:"page 4"}],e.activePage=0;var n=820;setTimeout(function(){n=$(".item").height()+20},500);var c=[0],l=n;c.push(l);for(var p in e.book.projects_a)l+=0!==e.book.projects_a[p].files.length?2*n:n,c.push(l);var u=$(document).height()-n+300;console.log(u),$(".preview").scroll(function(){for(var t=Math.floor($(".preview").scrollTop()+u),o=0;o<c.length-1;o++)t>=c[o]&&t<c[o+1]&&e.activePage!=o&&(e.activePage=o,e.$apply())}),e.exportBox=!1,e.export=function(){function t(){for(var o="",c=0;5>=c;c++)o+=c%2===0?a[Math.floor(Math.random()*a.length)]:n[Math.floor(Math.random()*n.length)];var l=$.param({file_title:o,data:e.book});s({url:"templating/export.php",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:l}).then(function(a){"ok"!=a.data.error?(r++,r>=10?i("error","Erreur interne","Une erreur s'est produite, contactez un administrateur ... Code d'erreur : REQ01"):t()):(i("success","Votre cahier a été exporté","Votre cahier a bien été exporté"),e.book.exported=o,e.saveBook(!1))},function(){i("error","Erreur interne","Une erreur s'est produite, contactez un administrateur ... Code d'erreur : REQ02")})}if(e.book.exported){var o=$.param({file:e.book.exported+".json"});s({url:"templating/dexport.php",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:o}).then(function(t){console.log(t),"ok"!=t.data.error?i("error","Erreur interne","Une erreur s'est produite, contactez un administrateur ... Code d'erreur : REQ03"):(i("success","Votre cahier a été mis hors ligne","Celui-ci n'est désormais plus accessible aux visiteurs."),e.book.exported=!1,e.saveBook(!1))},function(){i("error","Erreur interne","Une erreur s'est produite, contactez un administrateur ... Code d'erreur : REQ02")})}else{var r=0,a="aeiouy".split(""),n="bcdfghjklmnpqrstvwxz".split("");t(),e.exportBox=!0}},e.closeExportedBox=function(){e.exportBox=!1}}]),App.factory("Books",["localStorageService",function(e){function t(t){null===t&&e.set("books",[])}return{get:function(o){o=parseInt(o);var r=e.get("books"),i=[];if(t(r),0!==o)for(var a in r)r[a].category==o&&i.push(r[a]);else i=r;return i},getById:function(o){o=parseInt(o);{var r=e.get("books");e.get("projects")}t(r);var i={};for(var a in r)r[a].id==o&&(i=r[a]);return i},saveLocal:function(t){e.set("books",t)},add:function(t){var o=e.get("books"),r=0;for(var i in o)r=o[i].id;return t.id=r+1,o.push(t),e.set("books",o),t.id},edit:function(t,o){t=parseInt(t);var r=e.get("books");for(var i in r)r[i].id==t&&(last_id=i);r[last_id]=o,e.set("books",r),console.log(r[last_id])},validate:function(e){var t=150,o=2,r=100,i=50,a=500,s=1,n=[];return"dist/img/sample.png"==e.cover&&n.push("ajoutez une photo de couverture"),e.btitle.length<o&&n.push("titre trop court"),e.btitle.length>r&&n.push("titre trop long"),e.projects_a.length<s&&n.push("ajoutez au moins un projet"),e.date.length>i&&n.push("date trop longue"),e.bottomline.length>t&&n.push("informations complémentaires trop longues"),e.subtitle.length>a&&n.push("description trop longue"),0===n.length?!0:(n=n.join(", "),n=n.charAt(0).toUpperCase()+n.slice(1)+".")}}}]),App.controller("BooksCtrl",["$scope","Books","navService","$routeParams","Notify","Categories",function(e,t,o,r,i,a){var s=a.get();e.cat_id=r.book_id,e.books=t.get(r.book_id),e.deleteBook=function(o){i("question","Voulez-vous vraiment supprimer ce cahier ?",{question:"Vous vous apprêtez à supprimer un cahier. Cette action est irréversible. Voulez-vous vraiment faire ça ?",yes:"Oui",no:"non"}),e.$on("clickDialog",function(r,a){if(i("close"),"yes"==a.choice){for(var s in e.books)e.books[s].id==o&&(e.books.splice(s,1),i("success","Cahier supprimé","Le cahier a été supprimé avec succès"));t.saveLocal(e.books)}})},e.cat_name=s.books[e.cat_id].title,e.button_rename=!1,e.toggleRenameInput=function(){e.button_rename=!e.button_rename,e.button_rename===!0&&e.$broadcast("inputRenameShown")},e.changeCategoryName=function(t){(13===t.which||"click"==t.type&&""!==e.cat_name)&&(s.books[e.cat_id].title=e.cat_name,a.saveLocal(s),e.toggleRenameInput())}}]),App.factory("exportService",function(){return{"export":function(){return active}}}),App.factory("Themes",function(){return{get:function(){var e=[{id:0,title:"Theme 1",src:"theme1"},{id:1,title:"Theme 2",src:"theme2"},{id:2,title:"Theme 3",src:"theme3"},{id:3,title:"Theme 4",src:"theme4"}];return e}}}),App.controller("AddProjectCtrl",["$scope","Projects","Categories","$routeParams","Notify","$location",function(e,t,o,r,i,a){utils.fixBottomBoxHeight(),e.categories=o.get(),e.projects=t.get(0);var s=new Date;e.project_data={intro:"Introduction au projet",title:"Titre du projet",date:s.getDate()+"/"+(s.getMonth()+1)+"/"+s.getFullYear(),desc:"Lorem ipsum dolor sit amet, consectetur adipisicing elit. Adipisci repellendus alias modi praesentium, delectus! Itaque odit ratione sit quisquam quia, cum quaerat ipsam mollitia vero deserunt. Asperiores atque nesciunt quidem.",tags:[],category:0,cover:"dist/img/sample.png",files:[]},e.isUploading=!1,e.uploadImg=function(){e.isUploading=!0},void 0!==r.project_id&&(e.project_data=t.getById(r.project_id)),e.addProject=function(){var o=e.project_data,s=t.validate(o);if(s!==!0)return i("error","Erreur lors de l'ajout",s),!1;o.hasOwnProperty("id")?void 0!==r.project_id&&(t.edit(r.project_id,o),i("success","Projet modifié","Le projet a été modifié avec succès")):(t.add(o),i("success","Projet ajouté","Le projet a été ajouté avec succès")),a.path("/projects/0")},e.selectCategory=function(t){e.project_data.category=e.categories.projects[t].id},e.addTag=function(t){13===t.which&&""!==e.addedTag&&(e.project_data.tags.push(e.addedTag),e.addedTag="")},e.deleteTag=function(t){return e.project_data.tags.splice(t,1),!1},e.deleteMedia=function(t){e.project_data.files.splice(t,1)},e.uploadCoverComplete=function(t){e.isUploading=!1,"success"==t.status?e.project_data.cover="uploads/files/"+t.fileName:i("error","Erreur d'upload","Image de couverture refusée, verifiez la taille et l'extension de votre fichier.")},e.uploadComplete=function(t){e.isUploading=!1,"success"==t.status?e.project_data.files.push({path:"uploads/files/"+t.fileName}):i("error","Erreur d'upload","Upload refusé, verifiez la taille et l'extension de votre fichier.")}}]),App.factory("Projects",["localStorageService",function(e){function t(t){null===t&&e.set("projects",[])}return{get:function(o){o=parseInt(o);var r=e.get("projects"),i=[];if(t(r),0!==o)for(var a in r)r[a].category==o&&i.push(r[a]);else i=r;return i},getById:function(o){o=parseInt(o);var r=e.get("projects");t(r);for(var i in r)if(r[i].id==o)return r[i]},saveLocal:function(t){e.set("projects",t)},add:function(t){var o=e.get("projects"),r=0;for(var i in o)r=o[i].id;return t.id=r+1,o.push(t),e.set("projects",o),t.id},edit:function(t,o){t=parseInt(t);var r=e.get("projects");for(var i in r)r[i].id==t&&(last_id=i);r[last_id]=o,e.set("projects",r)},validate:function(e){var t=3,o=50,r=1200,i=100,a=100,s=10,n=10,c=[];return"dist/img/sample.png"==e.cover&&c.push("ajoutez une photo de couverture"),e.title.length<t&&c.push("titre trop court"),e.title.length>o&&c.push("titre trop long"),e.desc.length>r&&c.push("description trop longue"),e.intro.length>i&&c.push("introduction trop longue"),e.date.length>a&&c.push("date trop longue"),e.tags.length>s&&c.push("trop de tags (maximum "+s+")"),e.files.length>n&&c.push("trop de fichiers (maximum "+n+")"),0===c.length?!0:(c=c.join(", "),c=c.charAt(0).toUpperCase()+c.slice(1)+".")}}}]),App.controller("ProjectsCtrl",["$scope","Projects","$routeParams","Notify","Categories",function(e,t,o,r,i){var a=i.get();e.cat_id=o.project_id,e.projects=t.get(o.project_id),e.deleteProject=function(o){for(var i in e.projects)e.projects[i].id==o&&(e.projects.splice(i,1),r("success","Projet supprimé","Le projet a été supprimé avec succès"));t.saveLocal(e.projects)},e.cat_name=a.projects[e.cat_id].title,e.button_rename=!1,e.toggleRenameInput=function(){e.button_rename=!e.button_rename,e.button_rename===!0&&e.$broadcast("inputRenameShown")},e.changeCategoryName=function(t){(13===t.which||"click"==t.type&&""!==e.cat_name)&&(a.projects[e.cat_id].title=e.cat_name,i.saveLocal(a),e.toggleRenameInput())}}]);